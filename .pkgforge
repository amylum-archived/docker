name 'docker'
org 'amylum'

deps(
  lvm2: {
    version: '2.02.174-4',
    checksum: '6ab0e222088f4bedc913a73f70e88d8959e03e7dc35e79e12fd7dddb3788f74d'
  },
  'linux-api-headers': {
    version: '4.13-1',
    checksum: '50b2288419fe132c061bdf3d297293011929abc1092ffaa5e523ad6549b4f5fa'
  },
  'btrfs-progs': {
    version: '4.13.1-1',
    checksum: '9b0e2a48bd2deb1b6910cba40f42669b28a0c92031d9a75b6529504bb331121b'
  }
)

cflags
harden

patch 'ldflags.patch'

build do
  gopath = tmpdir(:gopath)
  run "mkdir -p #{gopath}/src/github.com/docker"
  run "ln -s #{tmpdir(:build)} #{gopath}/src/github.com/docker/docker"
  run "cp -R #{tmpdir(:build)}/vendor/* #{gopath}/"

  gitcommit = `git -C upstream rev-parse --short HEAD`.chomp
  run './hack/make.sh binary', {
    'DOCKER_GITCOMMIT' => gitcommit,
    'GOPATH' => gopath,
    'CC' => 'musl-gcc',
    'CGO_CFLAGS' => @forge.cflags.join(' '),
    'CGO_LDFLAGS' => @forge.cflags.join(' '),
    'PKG_CONFIG' => '/bin/true'
  }

  run "mkdir -p #{releasedir}/usr/bin"
  run "cp bundles/latest/binary-client/docker #{releasedir}/usr/bin/"
  run "cp bundles/latest/binary-daemon/dockerd #{releasedir}/usr/bin/"
end

test do
  run 'docker -v'
end
