name 'docker'
org 'amylum'

deps(
  lvm2: {
    version: '2.02.181-3',
    checksum: 'a6a2a843c3a98a1ff3162eefb9700cc8027fd6960ff03492a7903f8fc01c0194'
  },
  'linux-api-headers': {
    version: '4.18-1',
    checksum: 'edc8dab0e57cb3868867a86d501eb5f314ad00d87e50957c3ffae113ce967298'
  },
  'btrfs-progs': {
    version: '4.17.1-2',
    checksum: 'abc810d124b2405b6d9f9215403c1b47de3980f8b908f4be654a9ea7ad28feae'
  },
  libtool: {
    version: '2.4.6-2',
    checksum: '5a3a7cd180e16e399501a10cc13da752e4d4e3f86b73ae9afa5ffa9f63b86d3a'
  },
  libseccomp: {
    version: '2.3.3-5',
    checksum: '21d8e5462ad970bbda98214589323bc16d5d9f1c0e025a6008a773996b33e58d'
  }
)

cflags
harden

build do
  gopath = tmpdir(:gopath)
  ENV['GOPATH'] = gopath

  git_hash = `git --git-dir #{tmpdir(:build)}/.git rev-parse --short HEAD`.strip
  git_version = `git --git-dir #{tmpdir(:build)}/.git describe --tag | sed 's/^v//'`.strip

  def link_component(src, target)
    run "mkdir -p #{ENV['GOPATH']}/src/#{target}"
    run "rm -r #{ENV['GOPATH']}/src/#{target}"
    run "ln -s #{tmpdir(:build)}/components/#{src}/ #{ENV['GOPATH']}/src/#{target}"
  end

  link_component('cli', 'github.com/docker/cli')
  run(
      "make -C #{ENV['GOPATH']}/src/github.com/docker/cli VERSION=#{git_version} dynbinary",
      "DISABLE_WARN_OUTSIDE_CONTAINER" => "1",
      'CC' => 'musl-gcc',
      'CGO_CFLAGS' => @forge.cflags.join(' '),
      'CGO_LDFLAGS' => @forge.cflags.join(' '),
      'PKG_CONFIG' => '/bin/true'
  )

  link_component('engine', 'github.com/docker/docker')
  run(
    "cd #{ENV['GOPATH']}/src/github.com/docker/docker && ./hack/make.sh dynbinary",
    "DOCKER_BUILDTAGS" => "seccomp",
    "VERSION" => git_version,
    "DOCKER_GITCOMMIT" => git_hash,
    'CC' => 'musl-gcc',
    'CGO_CFLAGS' => @forge.cflags.join(' '),
    'CGO_LDFLAGS' => @forge.cflags.join(' '),
    'PKG_CONFIG' => '/bin/true'
  )
end

test do
  run 'docker -v'
end
