name 'docker'
org 'amylum'

deps(
  lvm2: {
    version: '2.02.183-1',
    checksum: '323a0acdf8ccea86452745d1932d9d1f991a89e8e0adc757b1066e65a8c2ff92'
  },
  'linux-api-headers': {
    version: '4.20-1',
    checksum: 'aed037b2b3fb2df77ca19359a20188d39c25d011febf4d3733d251fa87ca9636'
  },
  'btrfs-progs': {
    version: '4.19.1-1',
    checksum: 'efa0ad0cb96cd3c186f4929e8be9dff691cc16366a69b25c6ec59a858161cadc'
  },
  libtool: {
    version: '2.4.6-2',
    checksum: '5a3a7cd180e16e399501a10cc13da752e4d4e3f86b73ae9afa5ffa9f63b86d3a'
  },
  libseccomp: {
    version: '2.3.3-6',
    checksum: '78b400bc4b40281cef6d4d31a26035dbdfade3e0b0802c719a640c897f9ed745'
  }
)

cflags
harden

build do
  gopath = tmpdir(:gopath)
  ENV['GOPATH'] = gopath

  git_hash = `git --git-dir #{tmpdir(:build)}/.git rev-parse --short HEAD`.strip
  git_version = `git --git-dir #{tmpdir(:build)}/.git describe --tag | sed 's/^v//'`.strip

  def link_component(src, target)
    run "mkdir -p #{ENV['GOPATH']}/src/#{target}"
    run "rm -r #{ENV['GOPATH']}/src/#{target}"
    run "ln -s #{tmpdir(:build)}/components/#{src}/ #{ENV['GOPATH']}/src/#{target}"
  end

  link_component('cli', 'github.com/docker/cli')
  run(
      "make -C #{ENV['GOPATH']}/src/github.com/docker/cli VERSION=#{git_version} dynbinary",
      "DISABLE_WARN_OUTSIDE_CONTAINER" => "1",
      'CC' => 'musl-gcc',
      'CGO_CFLAGS' => @forge.cflags.join(' '),
      'CGO_LDFLAGS' => @forge.cflags.join(' '),
      'PKG_CONFIG' => '/bin/true'
  )

  link_component('engine', 'github.com/docker/docker')
  run(
    "cd #{ENV['GOPATH']}/src/github.com/docker/docker && ./hack/make.sh dynbinary",
    "DOCKER_BUILDTAGS" => "seccomp",
    "VERSION" => git_version,
    "DOCKER_GITCOMMIT" => git_hash,
    'CC' => 'musl-gcc',
    'CGO_CFLAGS' => @forge.cflags.join(' '),
    'CGO_LDFLAGS' => @forge.cflags.join(' '),
    'PKG_CONFIG' => '/bin/true'
  )
end

test do
  run 'docker -v'
end
