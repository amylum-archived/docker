name 'docker'
org 'amylum'

deps(
  lvm2: {
    version: '2.02.183-3',
    checksum: 'feb96740db89ad924f79a2e43d6fc9609e689633a7318fea284f685e30ecf210'
  },
  'linux-api-headers': {
    version: '4.20-1',
    checksum: 'aed037b2b3fb2df77ca19359a20188d39c25d011febf4d3733d251fa87ca9636'
  },
  'btrfs-progs': {
    version: '4.19.1-4',
    checksum: '6ca0f03b2a5261f7b4c98a645d9284e2f09900f603aef006cd2527a0226e75fd'
  },
  libtool: {
    version: '2.4.6-2',
    checksum: '5a3a7cd180e16e399501a10cc13da752e4d4e3f86b73ae9afa5ffa9f63b86d3a'
  },
  libseccomp: {
    version: '2.3.3-7',
    checksum: '7d4152c1350a68f714b3a79413f806e30c072f91e877b6343370cbe4ff7e8774'
  }
)

cflags
harden

build do
  gopath = tmpdir(:gopath)
  ENV['GOPATH'] = gopath

  git_hash = `git --git-dir #{tmpdir(:build)}/.git rev-parse --short HEAD`.strip
  git_version = `git --git-dir #{tmpdir(:build)}/.git describe --tag | sed 's/^v//'`.strip

  def link_component(src, target)
    run "mkdir -p #{ENV['GOPATH']}/src/#{target}"
    run "rm -r #{ENV['GOPATH']}/src/#{target}"
    run "ln -s #{tmpdir(:build)}/components/#{src}/ #{ENV['GOPATH']}/src/#{target}"
  end

  link_component('cli', 'github.com/docker/cli')
  run(
      "make -C #{ENV['GOPATH']}/src/github.com/docker/cli VERSION=#{git_version} dynbinary",
      "DISABLE_WARN_OUTSIDE_CONTAINER" => "1",
      'CC' => 'musl-gcc',
      'CGO_CFLAGS' => @forge.cflags.join(' '),
      'CGO_LDFLAGS' => @forge.cflags.join(' '),
      'PKG_CONFIG' => '/bin/true'
  )

  link_component('engine', 'github.com/docker/docker')
  run(
    "cd #{ENV['GOPATH']}/src/github.com/docker/docker && ./hack/make.sh dynbinary",
    "DOCKER_BUILDTAGS" => "seccomp",
    "VERSION" => git_version,
    "DOCKER_GITCOMMIT" => git_hash,
    'CC' => 'musl-gcc',
    'CGO_CFLAGS' => @forge.cflags.join(' '),
    'CGO_LDFLAGS' => @forge.cflags.join(' '),
    'PKG_CONFIG' => '/bin/true'
  )
end

test do
  run 'docker -v'
end
